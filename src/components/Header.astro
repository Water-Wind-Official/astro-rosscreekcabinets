---
import HeaderLink from './HeaderLink.astro';
import { SITE_TITLE } from '../consts';
---

<header>
	<nav>
		<div class="brand">
			<h2><a href="/">{SITE_TITLE}</a></h2>
			<p>Cabinetry built in Waycross, GA</p>
		</div>
		<div class="internal-links">
			<HeaderLink href="/">Home</HeaderLink>
			<HeaderLink href="/#services">Services</HeaderLink>
			<HeaderLink href="/#process">Process</HeaderLink>
			<HeaderLink href="/#portfolio">Portfolio</HeaderLink>
			<HeaderLink href="/#about">About</HeaderLink>
			<HeaderLink href="/#contact">Contact</HeaderLink>
		</div>
		<a class="cta" href="/#contact">Get a Quote</a>
	</nav>
</header>
<style>
	header {
		margin: 0;
		padding: 0 2em;
		background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
		backdrop-filter: blur(20px) saturate(1.2);
		-webkit-backdrop-filter: blur(20px) saturate(1.2);
		border-bottom: 2px solid #D4AF37;
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(212, 175, 55, 0.1);
		position: sticky;
		top: 0;
		z-index: 9999;
		isolation: isolate;
		transform: translateZ(0);
		-webkit-transform: translateZ(0);
		will-change: transform;
		pointer-events: auto;
	}
	nav {
		display: grid;
		grid-template-columns: auto 1fr auto;
		align-items: center;
		gap: 1em;
		max-width: 1200px;
		margin: 0 auto;
		min-height: 70px;
	}
	.brand h2 {
		margin: 0;
		font-size: 1.4em;
		font-weight: 900;
		letter-spacing: -0.02em;
		text-transform: uppercase;
	}
	.brand p {
		margin: 0.2em 0 0 0;
		font-size: 0.85em;
		color: #D4AF37;
		font-weight: 600;
		letter-spacing: 0.08em;
		text-transform: uppercase;
	}
	.brand a {
		text-decoration: none;
		color: #FFFFFF;
		padding: 0;
		border-radius: 0;
		transition: color 0.3s ease;
	}
	.brand a:hover {
		color: #D4AF37;
	}
	.internal-links {
		display: flex;
		align-items: center;
		flex-wrap: wrap;
		gap: 0.25em;
		justify-content: flex-end;
	}
	.internal-links a {
		padding: 1.2em 1em;
		color: rgba(255, 255, 255, 0.95);
		font-family: var(--font-display);
		font-size: 0.95em;
		font-weight: 700;
		text-decoration: none;
		text-transform: uppercase;
		letter-spacing: 0.05em;
		border-bottom: 3px solid transparent;
		border-radius: 0;
		transition: all 0.3s ease;
		position: relative;
	}
	.internal-links a::after {
		content: '';
		position: absolute;
		bottom: 0;
		left: 50%;
		width: 0;
		height: 2px;
		background: #D4AF37;
		transform: translateX(-50%);
		transition: width 0.3s ease;
	}
	.internal-links a:hover {
		background: rgba(212, 175, 55, 0.1);
		color: #D4AF37;
	}
	.internal-links a:hover::after {
		width: 80%;
	}
	.internal-links a.active {
		border-bottom-color: #D4AF37;
		background: rgba(212, 175, 55, 0.15);
		font-weight: 900;
		text-decoration: none;
		color: #D4AF37;
	}
	.internal-links a.active::after {
		width: 80%;
	}
	.cta {
		background: linear-gradient(135deg, #D4AF37 0%, #B8941F 100%);
		color: #000000;
		border-radius: 0;
		padding: 0.8em 1.5em;
		font-weight: 900;
		font-family: var(--font-display);
		font-size: 0.9em;
		text-transform: uppercase;
		letter-spacing: 0.08em;
		box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4), 0 0 0 1px rgba(212, 175, 55, 0.2);
		border: 2px solid #D4AF37;
		transition: all 0.3s ease;
		position: relative;
		overflow: hidden;
	}
	.cta::before {
		content: '';
		position: absolute;
		top: 0;
		left: -100%;
		width: 100%;
		height: 100%;
		background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
		transition: left 0.5s ease;
	}
	.cta:hover {
		background: linear-gradient(135deg, #E6C357 0%, #D4AF37 100%);
		transform: translateY(-2px);
		box-shadow: 0 8px 30px rgba(212, 175, 55, 0.6), 0 0 0 1px rgba(212, 175, 55, 0.3);
		color: #000000;
	}
	.cta:hover::before {
		left: 100%;
	}
	@media (max-width: 960px) {
		nav {
			grid-template-columns: 1fr;
			gap: 0.5em;
		}
		header {
			transform: translateZ(0);
			-webkit-transform: translateZ(0);
			will-change: transform;
			pointer-events: auto;
		}
		.brand {
			text-align: center;
		}
		.internal-links {
			display: none;
		}
		.cta {
			justify-self: center;
			width: 100%;
			text-align: center;
		}
		.cta-copy-row {
			display: flex;
			gap: 0.4em;
			flex-wrap: wrap;
			justify-content: center;
			justify-self: center;
			width: 100%;
		}
		.copy-btn {
			border: 1px solid rgba(212, 175, 55, 0.3);
			background: rgba(0, 0, 0, 0.8);
			color: #D4AF37;
			border-radius: 0;
			padding: 0.75em 1em;
			font-weight: 800;
			cursor: pointer;
			font-size: 0.85em;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			transition: all 0.3s ease;
			flex: 1 1 140px;
		}
		.copy-btn:hover {
			border-color: #D4AF37;
			color: #FFFFFF;
			background: rgba(212, 175, 55, 0.2);
			box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
		}
	}
</style>
<script type="module">
	if (typeof window !== "undefined") {
		const interceptSamePageHashLinks = (handler) => {
			const isMobile = window.matchMedia("(max-width: 960px)").matches;
			const links = Array.from(document.querySelectorAll('a[href*="#"]'));
			links.forEach((link) => {
				if (isMobile && link.classList.contains("cta")) return;
				const href = link.getAttribute("href") || "";
				if (!href) return;
				if (href.startsWith("mailto:") || href.startsWith("tel:")) return;
				let url;
				try {
					url = new URL(href, window.location.href);
				} catch {
					return;
				}
				if (!url.hash) return;
				if (url.pathname !== window.location.pathname) return;
				link.addEventListener("click", (e) => {
					e.preventDefault();
					history.pushState(null, "", url.hash);
					handler();
				});
			});
		};

		const scrollToHashTarget = () => {
			const hash = window.location.hash;
			if (!hash || hash.length < 2) return;
			const id = decodeURIComponent(hash.slice(1));
			const target = document.getElementById(id);
			if (!target) return;
			const header = document.querySelector("header");
			const offset = header ? Math.ceil(header.getBoundingClientRect().height) : 0;
			const rawSafe = getComputedStyle(document.documentElement)
				.getPropertyValue("--safe-area-top")
				.trim();
			const safe = Number.parseInt(rawSafe || "0", 10) || 0;
			const extra = 24;
			target.scrollIntoView({ block: "start", behavior: "auto" });
			window.scrollBy({ top: -(offset + safe + extra), left: 0, behavior: "auto" });
		};

		const updateHeaderOffset = () => {
			const header = document.querySelector("header");
			if (!header) return;
			const height = Math.ceil(header.getBoundingClientRect().height);
			document.documentElement.style.setProperty("--sticky-header-offset", `${height}px`);
			window.requestAnimationFrame(scrollToHashTarget);
			window.setTimeout(scrollToHashTarget, 50);
		};

		updateHeaderOffset();
		window.addEventListener("load", updateHeaderOffset);
		window.addEventListener("resize", updateHeaderOffset);
		window.addEventListener("hashchange", updateHeaderOffset);
		window.setTimeout(updateHeaderOffset, 250);
		if (document.fonts && typeof document.fonts.ready?.then === "function") {
			document.fonts.ready.then(updateHeaderOffset);
		}
	}
</script>

<script type="module">
	if (typeof window !== "undefined") {
		const isMobile = window.matchMedia("(max-width: 960px)").matches;
		if (isMobile) {
			const cta = document.querySelector("header a.cta");
			if (cta) {
				const fallbackCopy = (text) => {
					const area = document.createElement("textarea");
					area.value = text;
					document.body.appendChild(area);
					area.select();
					document.execCommand("copy");
					document.body.removeChild(area);
				};
				const copyText = async (text) => {
					if (navigator.clipboard?.writeText) {
						try {
							await navigator.clipboard.writeText(text);
							return true;
						} catch (err) {
							fallbackCopy(text);
							return false;
						}
					}
					fallbackCopy(text);
					return false;
				};

				const bindCopyButtons = (root) => {
					const buttons = Array.from(root.querySelectorAll("[data-copy]"));
					buttons.forEach((btn) => {
						const defaultLabel = btn.textContent;
						btn.addEventListener("click", async () => {
							const text = btn.getAttribute("data-copy") || "";
							await copyText(text);
							btn.textContent = "Copied!";
							setTimeout(() => {
								btn.textContent = defaultLabel;
							}, 1200);
						});
					});
				};

				cta.addEventListener("click", (e) => {
					e.preventDefault();
					if (document.querySelector("header .cta-copy-row")) return;

					const row = document.createElement("div");
					row.className = "cta-copy-row";
					row.innerHTML = `
						<button class="copy-btn" type="button" data-copy="+19123371152" aria-label="Copy phone number">Copy phone</button>
						<button class="copy-btn" type="button" data-copy="rosscreekcabinets@gmail.com" aria-label="Copy email address">Copy email</button>
					`;
					cta.replaceWith(row);
					bindCopyButtons(row);
				});
			}
		}
	}
</script>
<script type="module">
	if (typeof window !== "undefined") {
		const navLinks = Array.from(document.querySelectorAll("header .internal-links a"));
		const homeLink = navLinks.find((link) => (link.getAttribute("href") || "") === "/");

		const linkSections = navLinks
			.map((link) => {
				const href = link.getAttribute("href") || "";
				const hash = href.startsWith("#") ? href.substring(1) : href.includes("#") ? href.split("#")[1] : href === "/" ? "home" : "";
				if (!hash || hash === "home") return null;
				const section = document.getElementById(hash);
				return section ? { link, section } : null;
			})
			.filter(Boolean);

		const setActive = (activeLink) => {
			if (!activeLink) return;
			navLinks.forEach((l) => l.classList.remove("active"));
			activeLink.classList.add("active");
		};

		const highlightNearest = () => {
			const viewportMiddle = window.scrollY + window.innerHeight / 2;
			if (homeLink && linkSections[0]) {
				const firstSectionTop = linkSections[0].section.offsetTop;
				if (viewportMiddle < firstSectionTop) {
					setActive(homeLink);
					return;
				}
			}
			let closest;
			let closestDelta = Number.POSITIVE_INFINITY;
			linkSections.forEach((item) => {
				const rect = item.section.getBoundingClientRect();
				const middle = window.scrollY + rect.top + rect.height / 2;
				const delta = Math.abs(middle - viewportMiddle);
				if (delta < closestDelta) {
					closestDelta = delta;
					closest = item;
				}
			});
			if (closest) setActive(closest.link);
		};

		let ticking = false;
		const onScroll = () => {
			if (!ticking) {
				window.requestAnimationFrame(() => {
					highlightNearest();
					ticking = false;
				});
				ticking = true;
			}
		};

		if (linkSections.length) {
			const observer = new IntersectionObserver(
				(entries) => {
					const visible = entries
						.filter((e) => e.isIntersecting)
						.sort((a, b) => b.intersectionRatio - a.intersectionRatio);
					if (visible[0]) {
						const entry = visible[0];
						const match = linkSections.find((item) => item.section === entry.target);
						if (match) {
							setActive(match.link);
							return;
						}
					}
					// Fallback to nearest if nothing is intersecting
					highlightNearest();
				},
				{ rootMargin: "-30% 0px -50% 0px", threshold: [0.15, 0.35, 0.6, 0.85, 1] }
			);

			linkSections.forEach(({ section }) => observer.observe(section));

			// Ensure a default highlight on load
			highlightNearest();

			// Keep a nearest highlight as you scroll/resize
			window.addEventListener("scroll", onScroll, { passive: true });
			window.addEventListener("resize", highlightNearest);
		}
	}
</script>
